var ws;var u_id;var head_user="./Public/img/default_head.jpg";var username_ws;var sex=0;var token;var current_active=0;var current_username="";var current_head="./Public/img/default_head.jpg";var is_first=true;var ip;$(function(){$(document).ready(function(){var e=$(".hamburger"),t=$(".overlay"),a=false;e.click(function(){s()});function s(){if(a==true){t.hide();$(".blog-footer").removeClass("hide");e.removeClass("is-open");e.addClass("is-closed");a=false}else{t.show();$(".blog-footer").addClass("hide");e.removeClass("is-closed");e.addClass("is-open");a=true}}$('[data-toggle="offcanvas"]').click(function(){$("#wrapper").toggleClass("toggled")});$.ajax({url:"php/ajax.php",type:"POST",dataType:"json",data:{func:"is_login_home"},success:function(e){if(e.status==0){$(".blog-footer").removeClass("hide");$("#wrapper").removeClass("hide");$("#say_hello").removeClass("hide");$("#logout").removeClass("hide");$("#login_or_register").addClass("hide");$("#username").html(e.username);if(e.number>0){$("#message_number").html(e.number)}if(e.weight>2){$("#a_myBlog").removeClass("hide");$("#say_hello").prepend($('<li><a href="./admin.html">Admin</a></li>'))}u_id=e.u_id;username_ws=e.username;sex=e.sex;ip=e.ip;head_user=e.head;token=e.token;init_home(e);ws=new WebSocket("ws://127.0.0.1:19910");ws.onopen=ws_open;ws.onmessage=ws_onmessage;ws.onerror=ws_onerror;ws.onclose=ws_onclose;$("#textarea_editor").summernote({height:300,minHeight:null,maxHeight:null,focus:true,callbacks:{onImageUpload:function(e){var t=e[0].size;if(t>1024e4){toastr.error("图片大小不能超过10MB");return}var a=this;var s=new FormData;s.append("editormd-image-file",e[0]);$.ajax({url:"editor.md/examples/php/upload.php",type:"POST",data:s,dataType:"json",cache:false,contentType:false,processData:false,success:function(e){if(e.success==1){$("#"+a.id).summernote("insertImage",e.url)}else{toastr.warning(e.message)}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}}});$(".note-image-input").attr("multiple",null);$("#textarea_editor").next(":first").addClass("hide")}else{window.open("./"+loginString,"_self")}},error:function(e){toastr.error("HTTP状态码："+e.status)}})})});function logout(){$.ajax({url:"php/ajax.php",type:"POST",data:{func:"logout"},dataType:"json",success:function(e){if(e.status==0){ws.close();window.open("./index.html","_self")}else{toastr.warning(e.error)}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}function init_home(e){$("#head_picture").attr("src",e.head);$("#username_label").html(e.username);$("#email_label").html(e.email);document.getElementById("sex").childNodes[e.sex*2+1].setAttribute("selected",true);var t=e.message;var a=t==null?0:t.length;var s=$("#message_list");for(var r=0;r<a;r++){if(t[r].sex==1){var i="男"}else if(t[r].sex==2){var i="女"}else{var i="未知"}var n=$('<li class="click_to_chat" onclick="click_to_chat(this)" value='+t[r].from_id+' username="'+t[r].username+'" head="'+t[r].head+'" title="性别：'+i+'"></li>');n.appendTo(s);$('<a href="javascript:void(0);"><img src="'+t[r].head+'" style="width:3em" onerror="this.src=\'Public/img/default_head.jpg\'"></img>&nbsp;'+t[r].username+'<span class="badge pull-right" id="message_number_'+t[r].from_id+'">'+t[r].number+"</span></a>").appendTo(n)}$("#show_info").click(function(){if(current_active!=0){$(this).addClass("active");$(".click_to_chat").removeClass("active");$("#message_div_"+current_active).addClass("hide");$("#editormd").addClass("hide");$("#info").removeClass("hide");current_active=0}})}ws_open=function(){console.log("连接成功");var e={status:0,string:"设置当前用户",u_id:u_id,username:username_ws,token:token,ip:ip};e=JSON.stringify(e);ws.send(e)};ws_onmessage=function(e){data=JSON.parse(e.data);if(data.status==100){console.log("身份验证成功")}else if(data.status==0){$.ajax({url:"php/ajax.php",type:"POST",data:{func:"is_login_for_ws"},dataType:"json",success:function(e){if(e.status==0){if($(".click_to_chat[value="+data.from_id+"]").length==0){$.ajax({url:"php/ajax.php",type:"POST",data:{func:"get_someone",u_id:data.from_id},dataType:"json",success:function(e){if(e.status==0){var t=$("#message_list");if(e.sex==1){var a="男"}else if(e.sex==2){var a="女"}else{var a="未知"}var s=$('<li class="click_to_chat" onclick="click_to_chat(this)" value='+data.from_id+' username="'+e.username+'" head="'+e.head+'" title="性别：'+a+'"></li>');s.appendTo(t);$('<a href="javascript:void(0);"><img src="'+e.head+'" style="width:3em" onerror="this.src=\'Public/img/default_head.jpg\'"></img>&nbsp;'+e.username+'<span class="badge pull-right" id="message_number_'+data.from_id+'">'+1+"</span></a>").appendTo(s);var r=$('<div id="message_div_'+data.from_id+'" class="hide" last-id="0"></div>');$("#editormd").before(r);var i=$('<div class="panel panel-primary"></div>');i.appendTo(r);var n=$('<div class="panel-heading" style="text-align:center">'+e.username+'<a href="javascript:void(0);" title="全屏" class="pull-right" onclick="chat_fullscreen(this)"><i class="fa fa-arrows-alt" aria-hidden="true" style="color:white"></i></a></div>');n.appendTo(i);var o=$('<div class="panel-body" style="height:35em;overflow:auto"></div>');o.appendTo(i);var l=$("#message_number").html();if(l=="")$("#message_number").html("1");else $("#message_number").html(parseInt(l)+1)}else{toastr.warning(e.error)}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}else{if(data.from_id!=current_active){var t=$("#message_number").html();if(t=="")$("#message_number").html("1");else $("#message_number").html(parseInt(t)+1);var a=$("#message_number_"+data.from_id).html();if(a=="")$("#message_number_"+data.from_id).html("1");else $("#message_number_"+data.from_id).html(parseInt(a)+1)}else{$.ajax({url:"php/ajax.php",type:"POST",data:{func:"change_to_read",id:data.id},dataType:"json",success:function(e){if(e.status==0){var t=$("#message_div_"+current_active);var a=t.children(":first").children().eq(1);$('<div class="chat_time"><span>'+data.send_time+"</span></div>").appendTo(a);var s=$('<div class="chat_content_group buddy"></div>');s.appendTo(a);$('<img class="chat_content_avatar" src="'+current_head+'" width="40px" height="40px" onerror="this.src=\'Public/img/default_head.jpg\'">').appendTo(s);$('<p class="chat_nick">'+current_username+"</p>").appendTo(s);$('<div class="chat_content markdown-body">'+filterXSS(data.content)+"</div>").appendTo(s);$('<i class="fa fa-commenting" onclick="change_to_read(this)" title="未读" aria-hidden="true" style="font-size:1.5em;color:#1E90FF"></i>').appendTo(s);t.attr("last-id",data.id);a.scrollTop(a.prop("scrollHeight"))}else{toastr.warning(e.error)}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}$("#message_div_"+data.from_id).find(".fa-commenting").trigger("select")}toastr.info("You have new messages from "+data.from_username+". ").click(function(){$("li.click_to_chat[value="+data.from_id+"]").trigger("click")})}else{window.open("./"+loginString,"_self")}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}else if(data.status==1){$.ajax({url:"php/ajax.php",type:"POST",data:{func:"is_login_for_ws"},dataType:"json",success:function(e){if(e.status==0){var t=$("#message_div_"+data.to_id);var a=t.children(":first").children().eq(1);$('<div class="chat_time"><span>'+data.send_time+"</span></div>").appendTo(a);var s=$('<div class="chat_content_group self"></div>');s.appendTo(a);$('<img class="chat_content_avatar" src="'+head_user+'" width="40px" height="40px" onerror="this.src=\'Public/img/default_head.jpg\'">').appendTo(s);$('<p class="chat_nick">'+username_ws+"</p>").appendTo(s);$('<i class="fa fa-commenting" onselect="change_to_read(this)" title="未读" aria-hidden="true" style="font-size:1.5em;color:#1E90FF"></i>').appendTo(s);$('<div class="chat_content markdown-body">'+filterXSS(data.content)+"</div>").appendTo(s);t.attr("last-id",data.id);a.scrollTop(a.prop("scrollHeight"))}else{window.open("./"+loginString,"_self")}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}else if(data.status==-100){alert("他人异地登录，请确认密码是否泄露，即将退出登录");logout()}else{toastr.error(data.error)}};ws_onerror=function(){toastr.error("websocket出错啦")};ws_onclose=function(){};function click_to_chat(c){if(isMobile){$("#switch_editor").trigger("click")}else{if(is_first){testEditor=editormd("test-editormd",{width:"100%",height:400,path:"editor.md/lib/",theme:"default",previewTheme:"default",editorTheme:"base16-light",codeFold:true,saveHTMLToTextarea:true,searchReplace:true,htmlDecode:"style,script,iframe|on*",emoji:true,taskList:true,tocm:true,tex:true,flowChart:true,sequenceDiagram:true,imageUpload:true,imageFormats:["jpg","jpeg","pjpeg","ico","gif","png","bmp","webp"],imageUploadURL:"editor.md/examples/php/upload.php",onload:function(){console.log("onload",this)}});is_first=false}}var d=current_active;current_active=c.getAttribute("value");current_username=c.getAttribute("username");current_head=c.getAttribute("head");$(document).scrollTop(0);if($("#message_div_"+current_active).length==0){$.ajax({url:"php/ajax.php",type:"POST",dataType:"json",data:{func:"get_message",user:u_id,object:current_active},success:function(e){if(e.status==0){var t=$('<div id="message_div_'+current_active+'"></div>');$("#editormd").before(t);var a=$('<div class="panel panel-primary"></div>');a.appendTo(t);var s=$('<div class="panel-heading" style="text-align:center">'+current_username+'<a href="javascript:void(0);" title="全屏" class="pull-right" onclick="chat_fullscreen(this)"><i class="fa fa-arrows-alt" aria-hidden="true" style="color:white"></i></a></div>');s.appendTo(a);var r=$('<div class="panel-body" style="height:35em;overflow:auto"></div>');r.appendTo(a);if(e.message!=null){var i=e.message;var n=i.length;add_message(i,n,r,current_username,current_head);t.attr("last-id",i[n-1].id)}else{t.attr("last-id",0)}var o=$("#message_number_"+current_active).html();if(o!=""){$("#message_number_"+current_active).html("");var l=$("#message_number").html()-o;l=l==0?"":l;$("#message_number").html(l)}$(".click_to_chat").removeClass("active");c.className="click_to_chat active";if(d==0){$("#show_info").removeClass("active");$("#info").addClass("hide");$("#editormd").removeClass("hide")}else{$("#message_div_"+d).addClass("hide")}}else{toastr.warning(e.error)}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}else{var n=$("#message_div_"+current_active);n.removeClass("hide");var e=n.attr("last-id");n.find(".fa-commenting").trigger("click");$.ajax({url:"php/ajax.php",type:"POST",dataType:"json",data:{func:"get_new_message",user:u_id,object:current_active,last_id:e},success:function(e){if(e.status==0){if(e.message!=null){var t=n.children(":first").children().eq(1);var a=e.message;var s=a.length;add_message(a,s,t,current_username,current_head);n.attr("last-id",a[s-1].id)}var r=$("#message_number_"+current_active).html();if(r!=""){$("#message_number_"+current_active).html("");var i=$("#message_number").html()-r;i=i==0?"":i;$("#message_number").html(i)}$(".click_to_chat").removeClass("active");c.className="click_to_chat active";if(d==0){$("#show_info").removeClass("active");$("#info").addClass("hide");$("#editormd").removeClass("hide")}else if(d!=current_active){$("#message_div_"+d).addClass("hide")}}else{toastr.warning(e.error)}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}}function change_to_read(e){e.className="fa fa-check-circle-o";e.setAttribute("title","已读");e.style.color="green";e.removeAttribute("onclick")}function add_message(e,t,a,s,r){for(var i=0;i<t;i++){$('<div class="chat_time"><span>'+e[i].send_time+"</span></div>").appendTo(a);if(e[i].from_id==current_active){var n=$('<div class="chat_content_group buddy"></div>');n.appendTo(a);$('<img class="chat_content_avatar" src="'+r+'" width="40px" height="40px" onerror="this.src=\'Public/img/default_head.jpg\'">').appendTo(n);$('<p class="chat_nick">'+s+"</p>").appendTo(n);$('<div class="chat_content markdown-body">'+filterXSS(e[i].content)+"</div>").appendTo(n);if(e[i].is_read==0){$('<i class="fa fa-commenting" onclick="change_to_read(this)" title="未读" aria-hidden="true" style="font-size:1.5em;color:#1E90FF"></i>').appendTo(n)}else{$('<i class="fa fa-check-circle-o" title="已读" aria-hidden="true" style="font-size:1.5em;color:green"></i>').appendTo(n)}}else{var n=$('<div class="chat_content_group self"></div>');n.appendTo(a);$('<img class="chat_content_avatar" src="'+head_user+'" width="40px" height="40px" onerror="this.src=\'Public/img/default_head.jpg\'">').appendTo(n);$('<p class="chat_nick">'+username_ws+"</p>").appendTo(n);if(e[i].is_read==0){$('<i class="fa fa-commenting" onselect="change_to_read(this)" title="未读" aria-hidden="true" style="font-size:1.5em;color:#1E90FF"></i>').appendTo(n)}else{$('<i class="fa fa-check-circle-o" title="已读" aria-hidden="true" style="font-size:1.5em;color:green"></i>').appendTo(n)}$('<div class="chat_content markdown-body">'+filterXSS(e[i].content)+"</div>").appendTo(n)}}a.scrollTop(a.prop("scrollHeight"))}function send_message(){if($("#switch_editor").attr("value")==0){var e=document.getElementsByClassName("editormd-preview-container")[0].innerHTML;document.getElementsByClassName("editormd-preview-container")[0].innerHTML="";testEditor.setMarkdown("")}else{var e=$("#textarea_editor").summernote("code");$("#textarea_editor").summernote("code","")}if(e==""||/^\s+$/.test(e)){toastr.warning("您没有写任何有效的消息内容");return}var t={status:1,string:"发送消息",content:e,u_id:u_id,object:current_active,from_username:username_ws};t=JSON.stringify(t);ws_send(t)}function chat_fullscreen(e){Fullscreen(e.parentNode.parentNode);e.parentNode.nextSibling.style.height="95%";e.setAttribute("title","退出全屏");e.setAttribute("onclick","chat_exitFullscreen(this)")}function chat_exitFullscreen(e){exitFullscreen();e.parentNode.nextSibling.style.height="35em";e.setAttribute("title","全屏");e.setAttribute("onclick","chat_fullscreen(this)")}function Fullscreen(e){if(e.requestFullscreen){e.requestFullscreen()}else if(e.mozRequestFullScreen){e.mozRequestFullScreen()}else if(e.webkitRequestFullscreen){e.webkitRequestFullscreen()}else if(e.msRequestFullscreen){e.msRequestFullscreen()}}function exitFullscreen(){if(document.exitFullscreen){document.exitFullscreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}}function switch_editor(e){e=$(e);var t=e.parent(":first");if(e.attr("value")==0){t.children().eq(0).addClass("hide");t.children().eq(2).removeClass("hide");t.children().eq(1).summernote("focus");e.attr("value",1);e.html("USE MD")}else{if(is_first){testEditor=editormd("test-editormd",{width:"100%",height:400,path:"editor.md/lib/",theme:"default",previewTheme:"default",editorTheme:"base16-light",codeFold:true,saveHTMLToTextarea:true,searchReplace:true,htmlDecode:"style,script,iframe|on*",emoji:true,taskList:true,tocm:true,tex:true,flowChart:true,sequenceDiagram:true,imageUpload:true,imageFormats:["jpg","jpeg","pjpeg","ico","gif","png","bmp","webp"],imageUploadURL:"editor.md/examples/php/upload.php",onload:function(){console.log("onload",this)}});is_first=false}t.children().eq(0).removeClass("hide");t.children().eq(2).addClass("hide");e.attr("value",0);e.html("USE TEXTAREA")}}function ws_send(t){$.ajax({url:"php/ajax.php",type:"POST",data:{func:"is_login_for_ws"},dataType:"json",success:function(e){if(e.status==0){ws.send(t)}else{window.open("./"+loginString,"_self")}},error:function(e){toastr.error("HTTP状态码："+e.status)}})}