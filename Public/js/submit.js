var notice=false;var is_manager=false;$(function(){$(document).ready(function(){$("#cancel_submit_blog").attr("href","./myblog/"+Request["id"]+"/")})});function do_other_thing_islogin(){$.ajax({url:"php/ajax.php",type:"POST",dataType:"json",data:{func:"init_submit",id:Request["id"]},success:function(t){if(t.status==0){if(t.weight>2){is_manager=true}else{$("#submit_blog").html("提交")}var e=htmlDecode(t.htmlCode);$("#htmlCode").html(e);if(t.is_submit===true){if(t.notice===true)notice=true;$("#title").val(t.title);$("#author_name").html(t.author);if(t.summary!=null&&t.summary!="")$("#summary").val(html_decode(t.summary));if(t.cover!=null&&t.cover!=""){$("#cover_picture").attr("src",t.cover);$("#cover_picture").removeClass("hide");$("#button_cancel_cover").removeClass("hide")}show_tags(t.tags)}else{var a=$.parseHTML(e);$("#title").val(a[0].innerText);var r="";for(var i=1;i<4;i++){if(a[i]==undefined)break;if(a[i].innerText==undefined)continue;r+=a[i].innerText+"\n";if(r.length>300)break}$("#author_name").html(t.username);$("#summary").val(r);show_tags(null)}$("#submit_time").html(t.submit_time);$("#last_time").html(t.last_time)}else if(t.status==404){location.href="./404.html"}else if(t.status==-3){alert("您无权限编辑他人博客信息");location.href="./editor.html"}else{toastr.warning(t.error)}},error:function(t){toastr.error("HTTP状态码："+t.status)}})}function do_other_thing_logout(){location.href="./index.html"}function show_tags(t){$.ajax({url:"php/ajax.php",type:"POST",data:{func:"get_tag_list"},dataType:"json",success:function(e){if(e.status==0){if(e.tag_list!=null){var a=$("#tag-cloud");var r=e.tag_list;var i=r.length;for(var s=0;s<i;s++){$('<a href="javascript:void(0);" class="under_tag_cloud" tag_id='+r[s].tag_id+' value=0 onclick="be_selected(this)">'+r[s].label+"</a>").appendTo(a)}}if(t!=null){var l=t.length;for(var s=0;s<l;s++){$("a[tag_id="+t[s].tag_id+"]").trigger("click")}}}else{toastr.warning(e.error)}},error:function(t){toastr.error("HTTP状态码："+t.status)}})}$("#modify_name").click(function(t){t.preventDefault();if($(this).attr("value")==0){$("#author_name").addClass("hide");$("#fill_name").val($("#author_name").html());$("#fill_name").removeClass("hide");$("#cancel").removeClass("hide");$(this).html("保存");$(this).attr("value",1)}else{var e=$.trim($("#fill_name").val());if(!is_manager){if(e.toLowerCase()=="frankie"){toastr.error("抱歉，该笔名不可用");return}}if(e.length>100){$("#fill_name").focus();toastr.warning("笔名长度不能超过100");return}if(e==""||/^\s+$/.test(e)){$("#fill_name").focus();toastr.warning("笔名不能为空");return}$("#fill_name").addClass("hide");$("#cancel").addClass("hide");$("#author_name").html(e);$("#author_name").removeClass("hide");$(this).html("自定义笔名");$(this).attr("value",0)}});$("#cancel").click(function(){$("#fill_name").addClass("hide");$("#cancel").addClass("hide");$("#author_name").removeClass("hide");$("#modify_name").html("自定义笔名");$("#modify_name").attr("value",0)});$("#button_upload_cover").click(function(){$("#upload_cover").trigger("click")});$("#cover_picture").click(function(){$("#upload_cover").trigger("click")});$("#upload_cover").on("change",function(){var t=$(this)[0].files[0].size;if(t>1024e4){toastr.error("图片大小不能超过10MB");return}var e=new FormData;e.append("cover",$(this)[0].files[0]);e.append("id",Request["id"]);$.ajax({url:"php/uploads_cover.php",type:"POST",data:e,cache:false,contentType:false,processData:false,dataType:"json",success:function(t){if(t.status==0){$("#cover_picture").attr("src",t.url);$("#cover_picture").removeClass("hide");$("#button_cancel_cover").removeClass("hide");toastr.success("上传成功")}else{toastr.warning(t.error)}},error:function(t){toastr.error("HTTP状态码："+t.status)}})});$("#button_cancel_cover").click(function(){$("#cover_picture").attr("src","");$("#cover_picture").addClass("hide");$(this).addClass("hide")});$("#submit_blog").on("click",function(t){t.preventDefault();var e=$.trim($("#title").val());var a=$.trim($("#author_name").html());var r=$.trim($("#cover_picture").attr("src"));var i=$.trim($("#summary").val());if(e.length>300){$("#title").focus();toastr.warning("标题长度不能超过300");return}if(a.length>100){toastr.warning("笔名长度不能超过100");return}if(e==""||/^\s+$/.test(e)){$("#title").focus();toastr.warning("博客标题内容为空");return}if(a==""||/^\s+$/.test(a)){toastr.warning("笔名为空，请填写笔名");return}var s=new Array;var l=$("a.under_tag_cloud[value=1]");a_be_selected_length=l.length;if(a_be_selected_length!=0){for(var n=0;n<a_be_selected_length;n++){s[n]=l.eq(n).attr("tag_id")}}$.ajax({url:"php/ajax.php",type:"POST",data:{func:"submit_blog",id:Request["id"],title:e,author_name:a,cover:r,summary:i,tags:s,tag_be_selected_number:a_be_selected_length},dataType:"json",success:function(t){if(t.status==0){$("#submit_blog").attr("disabled",true);if(is_manager){toastr.success("博客发布成功，即将前往查看").click(function(){location.href="./blog/"+t.id+"/"});location.href="./blog/"+t.id+"/"}else{toastr.success("博客提交成功，请等待管理员审核通过").click(function(){location.href="./myblog/"+t.id+"/"});location.href="./myblog/"+t.id+"/"}}else{toastr.warning(t.error)}},error:function(t){toastr.error("HTTP状态码："+t.status)}})});$("#btn_add_label").click(function(){var t=$.trim($("#input_add_label").val());if(t==""||/^\s+$/.test(t)){$("#input_add_label").val("");$("#input_add_label").focus();toastr.warning("并未输入任何有效的标签名");return}$.ajax({url:"php/ajax.php",type:"POST",data:{func:"add_tag",label:t},dataType:"json",success:function(e){if(e.status==0){var a=$('<a href="javascript:void(0);" class="under_tag_cloud" tag_id='+e.id+' value=0 onclick="be_selected(this)">'+t+"</a>");a.appendTo($("#tag-cloud"));a.trigger("click");$("#input_add_label").val("")}else{toastr.warning(e.error)}},error:function(t){toastr.error("HTTP状态码："+t.status)}})});function be_selected(t){t=$(t);var e=t.attr("value");if(e==0){t.css("color","#ffffff");t.css("background","#2e6da4");t.attr("value",1)}else{t.css("color","");t.css("background","");t.attr("value",0)}}